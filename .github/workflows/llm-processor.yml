# .github/workflows/gemini-bulk-processor.yml
name: Gemini Bulk File Processor

on:
  workflow_dispatch:
    inputs:
      input_file:
        description: '–ü—É—Ç—å –∫ –≤—Ö–æ–¥–Ω–æ–º—É —Ñ–∞–π–ª—É –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏'
        required: true
        type: string
        default: 'data/facts27.txt'
      
      prompt:
        description: '–ü—Ä–æ–º–ø—Ç –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏'
        required: true
        type: string
        default: '–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —ç—Ç–æ—Ç —Ç–µ–∫—Å—Ç –∏ –≤—ã–¥–µ–ª–∏ –æ—Å–Ω–æ–≤–Ω—ã–µ —Ñ–∞–∫—Ç—ã'
      
      output_filename:
        description: '–ò–º—è –≤—ã—Ö–æ–¥–Ω–æ–≥–æ —Ñ–∞–π–ª–∞ (–±–µ–∑ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è)'
        required: true
        type: string
        default: 'processed_facts'
      
      model:
        description: '–ú–æ–¥–µ–ª—å Gemini API'
        required: false
        type: choice
        options:
          - 'gemini-2.0-flash'
          - 'gemini-2.0-flash-lite'
          - 'gemini-2.5-flash'
          - 'gemini-2.5-flash-lite'
          - 'gemini-1.5-flash'
        default: 'gemini-2.0-flash'
      
      chunk_size:
        description: '–†–∞–∑–º–µ—Ä —á–∞–Ω–∫–∞ –≤ —Ç–æ–∫–µ–Ω–∞—Ö (–º–µ–Ω—å—à–µ = –±–µ–∑–æ–ø–∞—Å–Ω–µ–µ –¥–ª—è Free Tier)'
        required: false
        type: choice
        options:
          - '30000'
          - '50000'
          - '80000'
          - '120000'
        default: '50000'
      
      delay_between_chunks:
        description: '–ó–∞–¥–µ—Ä–∂–∫–∞ –º–µ–∂–¥—É —á–∞–Ω–∫–∞–º–∏ –≤ —Å–µ–∫—É–Ω–¥–∞—Ö'
        required: false
        type: choice
        options:
          - '60'
          - '90'
          - '120'
          - '180'
        default: '90'

jobs:
  validate-inputs:
    name: Validate Inputs
    runs-on: ubuntu-latest
    outputs:
      file-exists: ${{ steps.check.outputs.exists }}
      estimated-time: ${{ steps.estimate.outputs.time }}
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Check if input file exists
      id: check
      run: |
        if [ -f "${{ github.event.inputs.input_file }}" ]; then
          echo "exists=true" >> $GITHUB_OUTPUT
          echo "‚úÖ –§–∞–π–ª –Ω–∞–π–¥–µ–Ω: ${{ github.event.inputs.input_file }}"
          
          # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞
          file_size=$(wc -c < "${{ github.event.inputs.input_file }}")
          echo "üìÅ –†–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞: $(($file_size / 1024))KB"
          
          # –ü—Ä–∏–º–µ—Ä–Ω–∞—è –æ—Ü–µ–Ω–∫–∞ —Ç–æ–∫–µ–Ω–æ–≤ (1 —Ç–æ–∫–µ–Ω ‚âà 4 —Å–∏–º–≤–æ–ª–∞)
          estimated_tokens=$(($file_size / 4))
          chunk_size=${{ github.event.inputs.chunk_size }}
          estimated_chunks=$(($estimated_tokens / $chunk_size + 1))
          
          echo "üî¢ –ü—Ä–∏–º–µ—Ä–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–∫–µ–Ω–æ–≤: $estimated_tokens"
          echo "üì¶ –ü—Ä–∏–º–µ—Ä–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —á–∞–Ω–∫–æ–≤: $estimated_chunks"
          
        else
          echo "exists=false" >> $GITHUB_OUTPUT
          echo "‚ùå –§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω: ${{ github.event.inputs.input_file }}"
          exit 1
        fi
    
    - name: Estimate processing time
      id: estimate
      if: steps.check.outputs.exists == 'true'
      run: |
        file_size=$(wc -c < "${{ github.event.inputs.input_file }}")
        estimated_tokens=$(($file_size / 4))
        chunk_size=${{ github.event.inputs.chunk_size }}
        estimated_chunks=$(($estimated_tokens / $chunk_size + 1))
        delay=${{ github.event.inputs.delay_between_chunks }}
        
        # –í—Ä–µ–º—è = –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —á–∞–Ω–∫–æ–≤ * –∑–∞–¥–µ—Ä–∂–∫–∞ + –≤—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏
        estimated_minutes=$((($estimated_chunks * $delay + $estimated_chunks * 30) / 60))
        
        echo "time=${estimated_minutes}" >> $GITHUB_OUTPUT
        echo "‚è±Ô∏è –ü—Ä–∏–º–µ—Ä–Ω–æ–µ –≤—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏: ${estimated_minutes} –º–∏–Ω—É—Ç"
        
        if [ $estimated_minutes -gt 60 ]; then
          echo "‚ö†Ô∏è –í–ù–ò–ú–ê–ù–ò–ï: –û–±—Ä–∞–±–æ—Ç–∫–∞ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –±–æ–ª–µ–µ —á–∞—Å–∞!"
        fi

  process-file:
    name: Process File with Gemini
    runs-on: ubuntu-latest
    needs: validate-inputs
    if: needs.validate-inputs.outputs.file-exists == 'true'
    
    permissions:
      contents: write
      actions: read
    
    env:
      GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
      PYTHONUNBUFFERED: 1
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Validate API key
      run: |
        if [ -z "$GEMINI_API_KEY" ]; then
          echo "‚ùå GEMINI_API_KEY –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤ Secrets"
          echo "–ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ Settings ‚Üí Secrets and variables ‚Üí Actions"
          echo "–î–æ–±–∞–≤—å—Ç–µ –Ω–æ–≤—ã–π secret —Å –∏–º–µ–Ω–µ–º GEMINI_API_KEY"
          exit 1
        else
          echo "‚úÖ API –∫–ª—é—á –Ω–∞–π–¥–µ–Ω"
        fi
    
    - name: Create output directory
      run: |
        mkdir -p outputs
        echo "üìÅ –°–æ–∑–¥–∞–Ω–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è outputs/"
    
    - name: Show processing parameters
      run: |
        echo "üîß –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –æ–±—Ä–∞–±–æ—Ç–∫–∏:"
        echo "   üìÑ –§–∞–π–ª: ${{ github.event.inputs.input_file }}"
        echo "   ü§ñ –ú–æ–¥–µ–ª—å: ${{ github.event.inputs.model }}"
        echo "   üì¶ –†–∞–∑–º–µ—Ä —á–∞–Ω–∫–∞: ${{ github.event.inputs.chunk_size }} —Ç–æ–∫–µ–Ω–æ–≤"
        echo "   ‚è±Ô∏è –ó–∞–¥–µ—Ä–∂–∫–∞: ${{ github.event.inputs.delay_between_chunks }} —Å–µ–∫—É–Ω–¥"
        echo "   üíæ –í—ã—Ö–æ–¥–Ω–æ–π —Ñ–∞–π–ª: ${{ github.event.inputs.output_filename }}.txt"
        echo "   üìù –ü—Ä–æ–º–ø—Ç: ${{ github.event.inputs.prompt }}"
    
    - name: Process file with Gemini API
      id: process
      run: |
        echo "üöÄ –ù–∞—á–∏–Ω–∞–µ–º –æ–±—Ä–∞–±–æ—Ç–∫—É —Ñ–∞–π–ª–∞..."
        
        # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫
        set +e
        
        python main.py \
          --file "${{ github.event.inputs.input_file }}" \
          --prompt "${{ github.event.inputs.prompt }}" \
          --output "outputs/${{ github.event.inputs.output_filename }}.txt" \
          --model "${{ github.event.inputs.model }}" \
          --chunk-size "${{ github.event.inputs.chunk_size }}" \
          --delay "${{ github.event.inputs.delay_between_chunks }}"
        
        exit_code=$?
        
        if [ $exit_code -eq 0 ]; then
          echo "‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ"
          echo "success=true" >> $GITHUB_OUTPUT
        else
          echo "‚ö†Ô∏è –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —Å –æ—à–∏–±–∫–∞–º–∏ (–∫–æ–¥: $exit_code)"
          echo "success=partial" >> $GITHUB_OUTPUT
        fi
    
    - name: Check output file
      id: check_output
      run: |
        output_file="outputs/${{ github.event.inputs.output_filename }}.txt"
        
        if [ -f "$output_file" ]; then
          file_size=$(wc -c < "$output_file")
          line_count=$(wc -l < "$output_file")
          
          echo "üìÑ –°–æ–∑–¥–∞–Ω —Ñ–∞–π–ª: $output_file"
          echo "üìè –†–∞–∑–º–µ—Ä: $(($file_size / 1024))KB"
          echo "üìù –°—Ç—Ä–æ–∫: $line_count"
          
          echo "file_created=true" >> $GITHUB_OUTPUT
          echo "file_size=$file_size" >> $GITHUB_OUTPUT
          
          # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–µ—Ä–≤—ã–µ —Å—Ç—Ä–æ–∫–∏ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
          echo "üîç –ü–µ—Ä–≤—ã–µ —Å—Ç—Ä–æ–∫–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞:"
          head -10 "$output_file"
          
        else
          echo "‚ùå –í—ã—Ö–æ–¥–Ω–æ–π —Ñ–∞–π–ª –Ω–µ —Å–æ–∑–¥–∞–Ω"
          echo "file_created=false" >> $GITHUB_OUTPUT
        fi
    
    - name: Upload result as artifact
      if: steps.check_output.outputs.file_created == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: ${{ github.event.inputs.output_filename }}-${{ github.event.inputs.model }}-result
        path: outputs/${{ github.event.inputs.output_filename }}.txt
        retention-days: 30
        compression-level: 0
    
    - name: Create processing summary
      if: always()
      run: |
        summary_file="outputs/processing_summary.md"
        
        cat > "$summary_file" << EOF
        # –û—Ç—á–µ—Ç –æ–± –æ–±—Ä–∞–±–æ—Ç–∫–µ —Ñ–∞–π–ª–∞
        
        ## –ü–∞—Ä–∞–º–µ—Ç—Ä—ã
        - **–í—Ö–æ–¥–Ω–æ–π —Ñ–∞–π–ª**: \`${{ github.event.inputs.input_file }}\`
        - **–ú–æ–¥–µ–ª—å**: \`${{ github.event.inputs.model }}\`
        - **–†–∞–∑–º–µ—Ä —á–∞–Ω–∫–∞**: ${{ github.event.inputs.chunk_size }} —Ç–æ–∫–µ–Ω–æ–≤
        - **–ó–∞–¥–µ—Ä–∂–∫–∞**: ${{ github.event.inputs.delay_between_chunks }} —Å–µ–∫—É–Ω–¥
        - **–í—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏**: $(date)
        
        ## –†–µ–∑—É–ª—å—Ç–∞—Ç
        - **–°—Ç–∞—Ç—É—Å**: ${{ steps.process.outputs.success || 'failed' }}
        - **–§–∞–π–ª —Å–æ–∑–¥–∞–Ω**: ${{ steps.check_output.outputs.file_created || 'false' }}
        EOF
        
        if [ "${{ steps.check_output.outputs.file_created }}" == "true" ]; then
          echo "- **–†–∞–∑–º–µ—Ä —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞**: $((${{ steps.check_output.outputs.file_size }} / 1024))KB" >> "$summary_file"
        fi
        
        echo "" >> "$summary_file"
        echo "## –ü—Ä–æ–º–ø—Ç" >> "$summary_file"
        echo "\`\`\`" >> "$summary_file"
        echo "${{ github.event.inputs.prompt }}" >> "$summary_file"
        echo "\`\`\`" >> "$summary_file"
        
        cat "$summary_file"
    
    - name: Upload summary
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: processing-summary
        path: outputs/processing_summary.md
        retention-days: 7
    
    - name: Commit results to repository (optional)
      if: steps.check_output.outputs.file_created == 'true'
      continue-on-error: true
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action Bot"
        
        # –î–æ–±–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ —Ñ–∞–π–ª—ã —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
        git add outputs/
        
        if git diff --staged --quiet; then
          echo "‚ÑπÔ∏è –ù–µ—Ç –Ω–æ–≤—ã—Ö —Ñ–∞–π–ª–æ–≤ –¥–ª—è –∫–æ–º–º–∏—Ç–∞"
        else
          timestamp=$(date '+%Y-%m-%d %H:%M:%S')
          git commit -m "ü§ñ –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–∞–π–ª–∞: ${{ github.event.inputs.output_filename }}.txt ($timestamp)"
          
          # –ü—Ä–æ–±—É–µ–º –∑–∞–ø—É—à–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è
          if git push; then
            echo "‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π"
          else
            echo "‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π (–Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–∞–≤)"
          fi
        fi

  notify-completion:
    name: Notify Completion
    runs-on: ubuntu-latest
    needs: [validate-inputs, process-file]
    if: always()
    
    steps:
    - name: Processing completion summary
      run: |
        echo "üéØ –û–ë–†–ê–ë–û–¢–ö–ê –ó–ê–í–ï–†–®–ï–ù–ê"
        echo "========================"
        echo "üìÑ –§–∞–π–ª: ${{ github.event.inputs.input_file }}"
        echo "ü§ñ –ú–æ–¥–µ–ª—å: ${{ github.event.inputs.model }}"
        echo "‚è±Ô∏è –í—Ä–µ–º—è: $(date)"
        
        if [ "${{ needs.process-file.result }}" == "success" ]; then
          echo "‚úÖ –°—Ç–∞—Ç—É—Å: –£—Å–ø–µ—à–Ω–æ"
          echo ""
          echo "üì• –°–∫–∞—á–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç:"
          echo "   1. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤–æ –≤–∫–ª–∞–¥–∫—É 'Actions'"
          echo "   2. –í—ã–±–µ—Ä–∏—Ç–µ —ç—Ç–æ—Ç workflow"
          echo "   3. –°–∫–∞—á–∞–π—Ç–µ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç '${{ github.event.inputs.output_filename }}-${{ github.event.inputs.model }}-result'"
        elif [ "${{ needs.process-file.result }}" == "failure" ]; then
          echo "‚ùå –°—Ç–∞—Ç—É—Å: –û—à–∏–±–∫–∞"
          echo "   –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –¥–ª—è –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–µ–π"
        else
          echo "‚ö†Ô∏è –°—Ç–∞—Ç—É—Å: –ß–∞—Å—Ç–∏—á–Ω–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ"
          echo "   –ù–µ–∫–æ—Ç–æ—Ä—ã–µ —á–∞–Ω–∫–∏ –º–æ–≥–ª–∏ –±—ã—Ç—å –æ–±—Ä–∞–±–æ—Ç–∞–Ω—ã"
        fi
        
        echo ""
        echo "üí° –°–æ–≤–µ—Ç—ã –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è:"
        echo "   - –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –º–µ–Ω—å—à–∏–π —Ä–∞–∑–º–µ—Ä —á–∞–Ω–∫–∞ –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏"
        echo "   - –£–≤–µ–ª–∏—á—å—Ç–µ –∑–∞–¥–µ—Ä–∂–∫—É –º–µ–∂–¥—É –∑–∞–ø—Ä–æ—Å–∞–º–∏"
        echo "   - –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥—É—é –º–æ–¥–µ–ª—å"
        echo "   - –†–∞—Å—Å–º–æ—Ç—Ä–∏—Ç–µ –ø–µ—Ä–µ—Ö–æ–¥ –Ω–∞ –ø–ª–∞—Ç–Ω—ã–π —Ç–∞—Ä–∏—Ñ"
